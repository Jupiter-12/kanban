## 背景

当前看板系统只有项目所有者可以访问自己的项目，无法实现团队协作和项目可见性。需要调整权限模型，实现：
- 所有项目对所有用户可见
- 基于角色的编辑权限控制

**约束条件：**
- 遵循项目宪章的简单优先原则
- 不引入额外中间件
- 保持单体架构

## 目标 / 非目标

**目标：**
- 所有用户登录后能看到所有项目和任务
- 普通用户只能编辑自己创建的项目
- 管理员可以编辑所有项目（但不能管理成员权限）
- 所有者（超级管理员）拥有所有权限

**非目标：**
- 不实现项目私有/公开切换
- 不实现细粒度的任务级权限

## 决策

### 用户角色设计

**决策：** 三种用户角色，使用 role 枚举字段区分

| 角色 | 说明 | 标识 |
|------|------|------|
| 所有者 (Owner) | 超级管理员，拥有所有权限 | user.role == 'owner' |
| 管理员 (Admin) | 可编辑所有项目，但不能管理成员 | user.role == 'admin' |
| 普通用户 (User) | 只能编辑自己的项目 | user.role == 'user' (默认) |

```
users 表新增字段
├── role (ENUM: owner, admin, user, default='user')  # 用户角色
```

### 权限模型设计

**决策：** 采用"全局可见 + 角色编辑"模型

| 操作 | 普通用户 | 管理员 | 所有者 |
|------|----------|--------|--------|
| 查看所有项目列表 | ✓ | ✓ | ✓ |
| 进入任意项目查看任务 | ✓ | ✓ | ✓ |
| 编辑自己的项目 | ✓ | ✓ | ✓ |
| 编辑他人的项目 | ✗ | ✓ | ✓ |
| 删除自己的项目 | ✓ | ✓ | ✓ |
| 删除他人的项目 | ✗ | ✓ | ✓ |
| 管理成员权限（设置角色） | ✗ | ✗ | ✓ |

**说明：** 
- 所有者是超级管理员，拥有所有权限
- 管理员可以编辑所有项目但不能管理成员权限
- 普通用户只能编辑自己创建的项目

### API 设计

**决策：** 调整项目列表和访问权限

```
# 项目 API（调整）
GET    /projects                    # 返回所有项目（不再过滤）
GET    /projects/{id}               # 任何用户都可访问
PUT    /projects/{id}               # 需要编辑权限
DELETE /projects/{id}               # 需要编辑权限

# 用户管理 API（新增，仅所有者可用）
PUT    /users/{id}/role             # 设置用户角色（仅所有者）
GET    /users                       # 获取用户列表
```

### 权限检查实现

**决策：** 创建简单的权限检查函数

```python
def can_view_project(user: User, project: Project) -> bool:
    """所有用户都可以查看任何项目"""
    return True

def can_edit_project(user: User, project: Project) -> bool:
    """检查用户是否有编辑权限"""
    # 所有者可以编辑所有项目
    if user.role == 'owner':
        return True
    # 管理员可以编辑所有项目
    if user.role == 'admin':
        return True
    # 普通用户只能编辑自己的项目
    return project.owner_id == user.id

def can_manage_members(user: User) -> bool:
    """检查用户是否可以管理成员权限（仅所有者）"""
    return user.role == 'owner'
```

## 风险 / 权衡

| 风险 | 缓解措施 |
|------|----------|
| 所有项目可见可能泄露敏感信息 | 当前需求明确要求全局可见，后续可添加私有项目功能 |
| 所有者权限过大 | 所有者数量应严格控制，通常只有一个 |

## 迁移计划

1. 用户表添加 `role` 字段，默认 'user'
2. 修改用户注册逻辑：首个用户自动成为所有者
3. 修改项目列表 API，返回所有项目
4. 修改项目访问权限检查逻辑
5. 新增角色管理 API（仅所有者可用）
6. 部署新 API

**回滚方案：**
- 保留原有权限检查逻辑作为备用
- 可通过配置开关切换权限模式

## 开放问题

- 无
